<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Chegadas SBGR - FlightAware (via Backend Java)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 40px; }
    .container { max-width: 1000px; margin: auto; background: #fff; box-shadow: 0 0 10px #ddd; padding: 30px; border-radius: 12px; }
    h1 { color: #0a3d62; }
    table { border-collapse: collapse; width: 100%; margin-top: 24px; }
    th, td { border: 1px solid #b2bec3; padding: 8px 12px; text-align: left; }
    th { background: #dfe6e9; }
    tr:nth-child(even) { background: #f1f2f6; }
    .loading { color: #888; }
    .error { color: red; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Chegadas no Aeroporto SBGR (FlightAware via Backend Java)</h1>
    <p>Voos chegando em SBGR (Guarulhos) via backend Java local.</p>
    <div id="message" class="loading">Carregando...</div>
    <table id="flights-table" style="display:none;">
      <thead>
        <tr>
          <th>Número do Voo</th>
          <th>Matrícula</th>
          <th>Tipo Aeronave</th>
          <th>Origem (IATA)</th>
          <th>Previsto</th>
          <th>Estimado</th>
          <th>Progresso (%)</th>
        </tr>
      </thead>
      <tbody id="flights-body"></tbody>
    </table>
  </div>
  <script>
    const API_HOSTS = [
      "https://gruv2.onrender.com",
      "http://44.226.145.213:10000",
      "http://54.187.200.255:10000",
      "http://34.213.214.55:10000",
      "http://35.164.95.156:10000",
      "http://44.230.95.183:10000",
      "http://44.229.200.200:10000"
    ];

    function fetchWithTimeout(resource, options = {}) {
      const { timeout = 5000 } = options;
      return Promise.race([
        fetch(resource, options),
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Timeout ao conectar')), timeout)
        )
      ]);
    }

    async function fetchFromFirstAvailable(urls) {
      for (const url of urls) {
        try {
          const resp = await fetchWithTimeout(url, { timeout: 5000 });
          if (resp.ok) return resp;
        } catch (e) {
          // ignora e tenta o próximo
        }
      }
      throw new Error("Nenhum dos endpoints respondeu.");
    }

    async function carregarChegadas() {
      const message = document.getElementById('message');
      const table = document.getElementById('flights-table');
      const tbody = document.getElementById('flights-body');
      message.textContent = 'Carregando...';
      message.className = 'loading';
      table.style.display = 'none';
      tbody.innerHTML = '';

      try {
        const resposta = await fetchFromFirstAvailable(API_HOSTS);
        const voos = await resposta.json();

        if (!Array.isArray(voos) || voos.length === 0) {
          message.textContent = 'Nenhuma chegada encontrada.';
          return;
        }

        for (const voo of voos) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${voo.flight_number ?? '-'}</td>
            <td>${voo.registration ?? '-'}</td>
            <td>${voo.aircraft_type ?? '-'}</td>
            <td>${voo.origin ?? '-'}</td>
            <td>${voo.scheduled_in ?? voo.scheduled_arrival ?? '-'}</td>
            <td>${voo.estimated_in ?? voo.estimated_arrival ?? '-'}</td>
            <td>${voo.progress_percent != null ? voo.progress_percent + '%' : '-'}</td>
          `;
          tbody.appendChild(tr);
        }

        message.textContent = '';
        table.style.display = '';
      } catch (erro) {
        message.textContent = 'Erro ao carregar dados: ' + erro.message;
        message.className = 'error';
      }
    }

    window.onload = carregarChegadas;
  </script>
</body>
</html>
